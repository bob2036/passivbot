FROM python:3.12-slim

WORKDIR /app

# Installer Rust et dépendances système
RUN apt-get update && apt-get install -y \
    curl \
    gcc \
    g++ \
    build-essential \
    tree \
    && curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    && rm -rf /var/lib/apt/lists/*

# Ajouter Rust au PATH
ENV PATH="/root/.cargo/bin:${PATH}"

# Copier tout le code source
COPY . .

# MEGA DEBUG pendant le BUILD
RUN echo "======================================== BUILD TIME DIAGNOSTIC" && \
    pwd && \
    ls -la /app && \
    echo "--- Contenu de /app/src ---" && \
    ls -la /app/src/ && \
    echo "--- Recherche passivbot_multi.py ---" && \
    find /app -name "passivbot_multi.py" && \
    echo "======================================== FIN BUILD DIAGNOSTIC"

# Installer dépendances Python
RUN pip install --no-cache-dir -r requirements-live.txt

# Compiler Rust
RUN cd passivbot-rust && cargo build --release

# CMD simple pour diagnostic
CMD ["/bin/bash", "-c", "echo '=== RUNTIME DIAGNOSTIC ===' && pwd && echo '--- ls /app ---' && ls -la /app && echo '--- ls /app/src ---' && ls -la /app/src 2>&1 && echo '--- find passivbot_multi.py ---' && find /app -name 'passivbot_multi.py' 2>&1 && echo '=== END DIAGNOSTIC ===' && sleep 3600"]
